<% node['apache']['listen_ports'].each do |port| -%>
<% if port != 443 -%>
<VirtualHost *:<%= port %>>
    RewriteEngine On
    RewriteRule .* https://%{SERVER_NAME}%{REQUEST_URI} [L,R=301]
</VirtualHost>
<% end %>
<% end %>

<VirtualHost *:443>
    ServerName <%= @params[:server_name] %>
    DocumentRoot "/var/www/html"
    RewriteEngine On
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout <%= node['apache']['timeout'] %>

    <% node['abiquo']['ui_apache_opts'].each do |opt, val| %>
    <%= opt %> <%= val %>
    <% end %>

    <Directory "/var/www/html/ui">
        Options MultiViews FollowSymLinks
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>

    RewriteRule ^/$ /ui/ [R]

<% node['abiquo']['ui_proxies'].each do |path, remote| %>
    <Location <%= path %>>
        ProxyPass <%= remote %>
        ProxyPassReverse <%= remote %>
    </Location>
<% end %>

    SSLEngine on
    SSLProtocol all -SSLv2
    SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW
    <% unless @params[:cert_file].nil? %>
    SSLCertificateFile <%= @params[:cert_file] %>
    <% end %>
    <% unless @params[:key_file].nil? %>
    SSLCertificateKeyFile <%= @params[:key_file] %>
    <% end %>
    <% unless @params[:ca_file].nil? %>
    SSLCACertificateFile <%= @params[:ca_file] %>
    <% end %>
</VirtualHost>
