<% node['apache']['listen_ports'].each do |port| -%>
<% if port != 443 -%>
<VirtualHost *:<%= port %>>
    RewriteEngine On
    RewriteRule .* https://%{SERVER_NAME}%{REQUEST_URI} [L,R=301]
</VirtualHost>
<% end %>
<% end %>

<VirtualHost *:443>
    ServerName <%= @params[:server_name] %>
    DocumentRoot "<%= node['platform_family'] == "debian" ? "/var/www/ui" : "/var/www/html/ui" %>"
    RewriteEngine On
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout <%= node['apache']['timeout'] %>

    <Directory "<%= node['platform_family'] == "debian" ? "/var/www/ui" : "/var/www/html/ui" %>">
        Options MultiViews FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    RewriteRule ^/$ /ui/ [R]

    <Location /api>
        ProxyPass ajp://localhost:<%= node['abiquo']['tomcat']['ajp-port'] %>/api
        ProxyPassReverse ajp://localhost:<%= node['abiquo']['tomcat']['ajp-port'] %>/api
        Require all granted
    </Location>

    <Location /am>
        ProxyPass ajp://localhost:<%= node['abiquo']['tomcat']['ajp-port'] %>/am
        ProxyPassReverse ajp://localhost:<%= node['abiquo']['tomcat']['ajp-port'] %>/am
        Require all granted
    </Location>
 
    <Location /m>
        ProxyPass ajp://localhost:<%= node['abiquo']['tomcat']['ajp-port'] %>/m
        ProxyPassReverse ajp://localhost:<%= node['abiquo']['tomcat']['ajp-port'] %>/m
        Require all granted
    </Location>

    <Location /legal>
        ProxyPass ajp://localhost:<%= node['abiquo']['tomcat']['ajp-port'] %>/legal
        ProxyPassReverse ajp://localhost:<%= node['abiquo']['tomcat']['ajp-port'] %>/legal
        Require all granted
    </Location>

    SSLEngine on
    SSLProtocol all -SSLv2
    SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW
    <% unless @params[:cert_file].nil? %>
    SSLCertificateFile <%= @params[:cert_file] %>
    <% end %>
    <% unless @params[:key_file].nil? %>
    SSLCertificateKeyFile <%= @params[:key_file] %>
    <% end %>
    <% unless @params[:ca_file].nil? %>
    SSLCACertificateFile <%= @params[:ca_file] %>
    <% end %>
</VirtualHost>
